<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Provider Enrollment Quality Assessment</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --accent-color: blue;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1 {
      font-size: clamp(1.8rem, 2vw + 1rem, 2.5rem);
    }

    .top-meta label {
      font-weight: bold;
      font-size: 14px;
      font-style: italic;
      font-family: Verdana, Geneva, Tahoma, sans-serif;
    }

    .form-section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin: 10px 0 5px;
    }

    input[type="text"], input[type="date"], textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .category-title {
  background-color: #3ac295;  /* Deep blue */
  color: rgb(0, 0, 0);
  font-weight: bold;
  padding: 10px 12px;
  border-radius: 8px;
  margin-top: 30px;
  font-size: 1.1rem;
  position:sticky;
  top: 0px;
  z-index: 3;
}

    .category-header {
  display: grid;
  grid-template-columns: 1fr 120px 120px 120px;
  font-weight: bold;
  padding: 5px 0;
  border-bottom: 1px solid #ccc;
  text-align: center;
  gap: 12px;
}

.question-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

.question-table th,
.question-table td {
  padding: 10px 15px;
  text-align: center;
  vertical-align: middle;
}

.question-table th:first-child,
.question-table td:first-child {
  text-align: left;
  width: 50%;
}

.question-table th {
  position: sticky;
  top: 0px;
  background-color: #f4f4f400;
  font-weight: bold;
  z-index: 2;
  border-bottom: 2px solid rgb(204, 204, 204)
}


  .question-row label {
   padding-right: 4px 0;
}
.form-wrapper {
  max-height: 900px;
  overflow-y: auto;
}


    .question-row input[type="radio"] {
      margin-right: 6px;
    }

    .score-label {
      font-weight: bold;
      color: var(--primary-color);
    }

    .submit-buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
    }

    #total-score {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      color: var(--accent-color);
    }

    /* Responsive Enhancements */
    @media (max-width: 768px) {
      .category-header,
      .question-row {
        grid-template-columns: 1fr;
      }

      .question-row label {
        margin-bottom: 5px;
      }

      input[type="text"], input[type="date"], textarea {
        font-size: 16px;
      }

      .submit-buttons {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
    }

    @media (max-width: 600px) {
      .submit-buttons {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 10px 0;
        border-top: 1px solid #ccc;
      }
    }
      .tooltip-wrapper {
  position: relative;
  display: inline-block;
  margin-left: 8px;
}

.tooltip-trigger {
  background-color: #e0e0e0;
  border-radius: 50%;
  display: inline-block;
  width: 18px;
  height: 18px;
  font-size: 13px;
  font-weight: bold;
  text-align: center;
  line-height: 18px;
  color: #333;
  cursor: default;
}

.tooltip-popup {
  display: none;
  position: absolute;
  top: 24px;
  left: 0;
  width: 260px;
  padding: 8px 10px;
  background: #ffffff;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  font-size: 13px;
  color: #333;
  z-index: 9999;
  white-space: normal;
}

/* Little arrow (speech bubble style) */
.tooltip-popup::before {
  content: "";
  position: absolute;
  top: -6px;
  left: 10px;
  border-width: 6px;
  border-style: solid;
  border-color: transparent transparent #ccc transparent;
}

.tooltip-popup::after {
  content: "";
  position: absolute;
  top: -5px;
  left: 10px;
  border-width: 5px;
  border-style: solid;
  border-color: transparent transparent #fff transparent;
}
.comment-icon {
  margin-left: 10px;
  cursor: pointer;
  font-size: 16px;
  vertical-align: middle;
}
.custom-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.custom-modal-content {
  background-color: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 500px;
  width: 90%;
}

.tooltip-wrapper:hover .tooltip-popup {
  display: block;
}

@media print {
  button {
    display: none;
}
}

  .comment-bubble-wrapper {
  position: relative;
  display: inline-block;
}

.inline-comment {
  position: absolute;
  top: 100%;
  left: 42px;
  background-color: rgb(255, 255, 255);
  color: #444;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 6px;
  font-style: italic;
  margin-top: 6px;
  max-width: 300px;
  z-index: 10;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  display: none;
}

.comment-icon.filled:hover + .inline-comment {
  display: block;
}


.comment-icon.filled {
  color: #007bff;
  font-weight: bold;
}

.comment-icon.filled::after {
  content: '';
  display: inline-block;
  width: 6px;
  height: 6px;
  background-color: red;
  border-radius: 50%;
  margin-left: 4px;
  vertical-align: middle;
}

.row-missing {
  box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.35) inset;
  transition: box-shadow 0.5s ease;
}


  </style>
</head>
<body>
  <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTy-HlXOKYLI2FAorBeRokPX352t7cGniE0y-sE3S1JeHm_5qlhuX_ureZkKfAoKQCSyw&usqp=CAU" alt="Company Logo" style="max-width: 250px; display: block; margin-bottom: 20px;">
  <h1>Provider Enrollment Quality Assessment</h1>

  <div class="form-section top-meta">
    <label for="qa-assessor">QA Assessor</label>
    <input type="text" id="qa-assessor">
    <label for="qa-date">QA Assessment Date</label>
    <input type="date" id="qa-date">
    <label for="account">Account</label>
    <input type="text" id="account">
    <label for="employee-name">Employee Name</label>
    <input type="text" id="employee-name">
    <label for="app-id">Application ID Number</label>
    <input type="text" id="app-id">
    <label for="app-date">Application Received Date</label>
    <input type="date" id="app-date">
    <label for="app-type">Application Type</label>
    <input type="text" id="app-type">
  </div>

  <div class="form-wrapper">
  <div id="dynamic-sections" class="form-section"></div>
</div>

  <div class="submit-buttons">
    <button type="button" onclick="handleSubmit()">Submit</button>
    <button type="button" onclick="clearForm()">New Form</button>
    <button type="button" onclick="saveFormData()">Save</button>
    <input type="file" id="load-input" accept=".json" style="display: none" />
    <button type="button" onclick="document.getElementById('load-input').click()">Load Assessment</button>
    <div id="total-score">Total Score: 0.0%</div>
  </div>

  <script>
    // ✅ Single source of truth: sections, questions, optional tooltips
const FORM_CONFIG = [
  {
    id: "enrollment_details",
    title: "Enrollment Details",
    items: [
      { id: "app_type",   label: "Enrollment Application Type", tooltip: "Must match provider's selected application category." },
      { id: "category",   label: "Enrollment Category",          tooltip: "Ensure selected category aligns with documentation provided." },
      { id: "dup_atn",    label: "Duplicate ATN",                tooltip: "Verify the application tracking number is unique." },
      { id: "prev_enroll",label: "Previously/Currently Enrolled",tooltip: "Check for existing enrollment to avoid duplication." }
    ]
  },
  {
    id: "provider_verification",
    title: "Provider Verification",
    items: [
      { id: "prov_name",  label: "Provider Name" },
      { id: "prov_dba",   label: "Provider DBA" },
      { id: "prov_npi",   label: "Provider NPI" },
      { id: "dob",        label: "Date of Birth" },
      { id: "tax_id",     label: "SSN or Tax ID" },
      { id: "ptype",      label: "Provider Type / Specialty" }
    ]
  },
  {
    id: "address_details",
    title: "Address Details",
    items: [
      { id: "service_addr", label: "Services Address" },
      { id: "billing_addr", label: "Billing Address" },
      { id: "corr_addr",    label: "Correspondence Address" }
    ]
  },
  {
    id: "screenings_compliance",
    title: "Screenings - Compliance",
    items: [
      { id: "taxonomy",   label: "Taxonomy Code" },
      { id: "board_cert", label: "Board Certification" },
      { id: "clia",       label: "CLIA" },
      { id: "dea",        label: "DEA" },
      { id: "accredit",   label: "Accreditation/Board (Facility)" },
      { id: "license",    label: "License" },
      { id: "nppes",      label: "National Plan and Provider Enumeration System (NPPES)" },
      { id: "pecos",      label: "PECOS" }
    ]
  },
  {
    id: "screenings_regulatory",
    title: "Screenings - Regulatory",
    items: [
      { id: "dmf",        label: "Social Security Administration's Death Master File (DMF)" },
      { id: "leie_med",   label: "LEIE or MED" },
      { id: "sam",        label: "System for Award Management (SAM)" },
      { id: "oig",        label: "Office of Inspector General (OIG)" },
      { id: "state_excl", label: "State specific exclusions" },
      { id: "dex",        label: "Decentralized Exchange (DEX)" },
      { id: "lexis",      label: "LexisNexis" }
    ]
  },
  {
    id: "screening_risk",
    title: "Screening - Risk",
    items: [
      { id: "irs",        label: "IRS" },
      { id: "site_visit", label: "Site Visit" },
      { id: "fcbc",       label: "Fingerprint based Criminal Background Check (FCBC)" },
      { id: "risk_level", label: "Risk Level" }
    ]
  },
  {
    id: "disclosures",
    title: "Disclosures",
    items: [
      { id: "own_ctrl_1", label: "Persons with Ownership or Control Interests (§ 455.104(b)(1))" },
      { id: "own_ctrl_2", label: "Ownership or Control Relationships (§ 455.104(b)(2))" },
      { id: "other_entity", label: "Name of Any Other Disclosing Entity" },
      { id: "managing_emp", label: "Managing Employee Disclosure" },
      { id: "dir_indir_own", label: "Direct or Indirect Ownership" },
      { id: "board_members", label: "Board Members" },
      { id: "disc_questions", label: "Disclosure Questions" }
    ]
  },
  {
    id: "application_completion",
    title: "Application Completion",
    items: [
      { id: "app_fee",   label: "Application Fee" },
      { id: "sig_date",  label: "Signature & Date" },
      { id: "attachments", label: "Attachments" }
    ]
  },
  {
    id: "application_actions",
    title: "Application Actions",
    items: [
      { id: "rtp",       label: "Return to Provider (RTP)" },
      { id: "approved",  label: "Approved - Contract/effective date, reval date" },
      { id: "denied",    label: "Denied/Rejected" }
    ]
  },
  {
    id: "system_docs_comments",
    title: "System Documents & Comments",
    items: [
      { id: "sma_notes",     label: "SMA system notes/comments" },
      { id: "screening_val", label: "Proper Screening Validation Completed and Documented" }
    ]
  },
];

const TOOLTIPS = FORM_CONFIG.reduce((acc, sec) => {
  for (const it of sec.items) if (it.tooltip) acc[it.label] = it.tooltip;
  return acc;
}, {});

// ✅ same function name/signature, now uses the generated tooltip map
function getTooltipText(question) {
  return TOOLTIPS[question] || "No additional guidance available.";
};

    function buildAssessmentForm(containerId) {
  const container = document.getElementById(containerId);

  for (const sec of FORM_CONFIG) {
    const section = document.createElement('div');
    section.className = 'form-section';

    section.innerHTML += `
<div class="category-title">
  ${sec.title}
  <span class="comment-bubble-wrapper">
    <span class="comment-icon" onclick="openCommentBox('${sec.id}')" id="${sec.id}-icon">📝</span>
    <span class="inline-comment" id="${sec.id}-comment-inline"></span>
  </span>
</div>

<table class="question-table">
  <thead>
    <tr>
      <th></th>
      <th>Yes</th>
      <th>No</th>
      <th>N/A</th>
    </tr>
  </thead>
  <tbody>
    ${sec.items.map((it, i) => `
      <tr>
        <td>
          <div>
            ${it.label}
            <span class="tooltip-wrapper">
              <span class="tooltip-trigger">i</span>
              <span class="tooltip-popup">${getTooltipText(it.label)}</span>
            </span>
          </div>
          <div class="inline-comment" id="${sec.id}-q-comment-${i}" style="font-size: 12px; color: #666; margin-top: 4px;"></div>
        </td>
        <td><input type="radio" name="${sec.id}-${it.id}" value="Yes" onchange="recalculateSectionScoreById('${sec.id}')"></td>
        <td><input type="radio" name="${sec.id}-${it.id}" value="No"  onchange="recalculateSectionScoreById('${sec.id}')"></td>
        <td><input type="radio" name="${sec.id}-${it.id}" value="N/A" onchange="recalculateSectionScoreById('${sec.id}')"></td>
      </tr>
    `).join('')}
  </tbody>
</table>
`;

    section.innerHTML += `
  <textarea rows="2" style="display: none;"></textarea>
  <div id="${sec.id}-score" class="score-label">Category Score: 0.0%</div>
`;
    container.appendChild(section);
  }
}
function tallySectionById(sectionId) {
  const sec = FORM_CONFIG.find(s => s.id === sectionId);
  if (!sec) return { yes: 0, answeredYN: 0, score: 0 };

  let yes = 0, answeredYN = 0;
  for (const it of sec.items) {
    const radios = document.getElementsByName(`${sectionId}-${it.id}`);
    for (const r of radios) {
      if (r.checked) {
        if (r.value === "Yes") yes++;
        if (r.value === "Yes" || r.value === "No") answeredYN++;
        break;
      }
    }
  }
  const score = answeredYN ? (yes / answeredYN) * 100 : 0;
  return { yes, answeredYN, score };
}

function recalculateSectionScoreById(sectionId) {
  const { score } = tallySectionById(sectionId);
  const sec = FORM_CONFIG.find(s => s.id === sectionId);
  const label = document.getElementById(`${sectionId}-score`);
  if (label && sec) {
    label.innerText = `${sec.title} Score: ${score.toFixed(1)}%`;
  }
  calculateScores(); // refresh totals
}

    function calculateScores() {
  let totalYes = 0, totalAnswered = 0;
  const scoreSummary = [];

  for (const sec of FORM_CONFIG) {
    const { yes, answeredYN, score } = tallySectionById(sec.id);

    // Update the section label (pretty display)
    const label = document.getElementById(`${sec.id}-score`);
    if (label) {
      label.innerText = answeredYN
        ? `${sec.title} Score: ${score.toFixed(1)}%`
        : `${sec.title} Score: — (N/A)`;
    }

    // Totals for the whole form (math still ignores N/A)
    totalYes += yes;
    totalAnswered += answeredYN;

    // Build the summary row (include display string)
    const comment = document.querySelector(`#${sec.id}-score`).previousElementSibling.value.trim();
    const sectionScoreDisplay = answeredYN ? `${score.toFixed(1)}%` : '— (N/A)';
    scoreSummary.push({
      category: sec.title,
      score: score.toFixed(1),         // numeric, if you need it later
      scoreDisplay: sectionScoreDisplay, // pretty text for the popup
      comment: comment || null
    });
  }

  // Footer total (pretty + numeric)
  const final = totalAnswered ? (100 * totalYes / totalAnswered).toFixed(1) : null;
  const finalDisplay = totalAnswered ? `${final}%` : '— (N/A)';
  document.getElementById('total-score').innerText = `Total Score: ${finalDisplay}`;

  // meta for the popup
  const assessor     = document.getElementById('qa-assessor').value;
  const date         = document.getElementById('qa-date').value;
  const account      = document.getElementById('account').value;
  const employee     = document.getElementById('employee-name').value;
  const appId        = document.getElementById('app-id').value;
  const receivedDate = document.getElementById('app-date').value;
  const appType      = document.getElementById('app-type').value;

  return {
    scoreSummary,
    final,         // numeric total (null if N/A)
    finalDisplay,  // pretty total for UI/popup
    metaSummary:
`Assessor: ${assessor}
Date: ${date}
Account: ${account}
Employee: ${employee}
App ID: ${appId}
Received: ${receivedDate}
Type: ${appType}`
  };
}

function openScorePopup(metaSummary, scoreSummary, finalDisplay) {
  const popup = window.open("", "Score Summary", "width=600,height=800");

  popup.document.write(`
  <!DOCTYPE html>
  <html>
    <head>
      <title>Assessment Score Summary</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          padding: 30px;
          color: #333;
        }
        .score-comment {
          font-style: italic;
          color: #555;
          margin-top: 4px;
        }
        ul {
          list-style-type: disc;
          padding-left: 20px;
        }
        button.print-button {
          margin-top: 30px;
          padding: 8px 14px;
          font-size: 14px;
          background-color: #007bff;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        }
        @media print {
          .print-button {
            display: none;
          }
        }
      </style>
    </head>
    <body>
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTy-HlXOKYLI2FAorBeRokPX352t7cGniE0y-sE3S1JeHm_5qlhuX_ureZkKfAoKQCSyw&usqp=CAU" alt="Logo" style="max-width: 200px; display: block; margin-bottom: 15px;">
      <h2>Assessment Score Summary</h2>
      <div style="margin-bottom: 20px; white-space: pre-line;">${metaSummary}</div>

      <h3 style="border-bottom: 1px solid #ccc;">Section Scores</h3>
      <ul>
        ${scoreSummary.map(item => `
          <li>
            <strong>${item.category}:</strong> ${item.scoreDisplay}
            ${item.comment ? `<div class="score-comment">Comment: ${item.comment}</div>` : ''}
          </li>
        `).join('')}
      </ul>
      <div style="margin-top: 20px; font-weight: bold; font-size: 18px; color: #007bff;">
  Total Score: ${finalDisplay}
</div>
      <button class="print-button" onclick="window.print()">Print Summary</button>
    </body>
  </html>
`);

popup.document.close();
}

let currentCommentCatId = null;

function openCommentBox(catId) {
  currentCommentCatId = catId;
  const textarea = document.querySelector(`#${catId}-score`).previousElementSibling;
  document.getElementById("comment-input").value = textarea.value;
  document.getElementById("comment-modal").style.display = "flex";
}

function closeCommentBox() {
  document.getElementById("comment-modal").style.display = "none";
}

function saveComment() {
  const value = document.getElementById("comment-input").value.trim();
  const textarea = document.querySelector(`#${currentCommentCatId}-score`).previousElementSibling;
  textarea.value = value;

  const icon = document.getElementById(`${currentCommentCatId}-icon`);
  if (icon) icon.classList.toggle("filled", !!value);

  const inline = document.getElementById(`${currentCommentCatId}-comment-inline`);
  if (inline) inline.innerHTML = value ? `Comment: ${value}` : "";

  closeCommentBox();
}

function clearComment(catId, event) {
  event.stopPropagation();

  const textarea = document.querySelector(`#${catId}-score`).previousElementSibling;
  if (textarea) textarea.value = "";

  const icon = document.getElementById(`${catId}-icon`);
  if (icon) icon.classList.remove("filled");

  const inline = document.getElementById(`${catId}-comment-inline`);
  if (inline) inline.innerHTML = "";
}

   function handleSubmit() {
  if (!validateAllQuestionsAnswered()) {
    alert("Please answer all questions before submitting.");
    return;
  }

  const { scoreSummary, finalDisplay, metaSummary } = calculateScores();
  openScorePopup(metaSummary, scoreSummary, finalDisplay);
}
function validateAllQuestionsAnswered() {
  for (const sec of FORM_CONFIG) {
    for (const it of sec.items) {
      const name = `${sec.id}-${it.id}`;
      const radios = document.getElementsByName(name);
      let answered = false;
      for (const r of radios) { if (r.checked) { answered = true; break; } }

      if (!answered) {
        const firstInput = radios[0];
        const row = firstInput?.closest('tr');

        if (row) {
          // Scroll the missing row into view
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Brief highlight
          row.classList.add('row-missing');
          setTimeout(() => row.classList.remove('row-missing'), 1500);
        }

        // Move keyboard focus to the first radio to help the user act immediately
        if (firstInput) firstInput.focus();

        return false; // stop at the first missing question
      }
    }
  }
  return true; // everything answered
}

    function clearForm() {
  location.reload();
}

    function clearModalComment() {
  const textarea = document.getElementById("comment-input");
  if (textarea) textarea.value = "";
}

    async function saveFormData() {
  const assessor     = document.getElementById('qa-assessor').value;
  const date         = document.getElementById('qa-date').value;
  const account      = document.getElementById('account').value;
  const employee     = document.getElementById('employee-name').value;
  const appId        = document.getElementById('app-id').value;
  const receivedDate = document.getElementById('app-date').value;
  const appType      = document.getElementById('app-type').value;

  let grandYes = 0, grandAnswered = 0;
  const flatData = [];

  for (const sec of FORM_CONFIG) {
  const sectionId = sec.id;
  const category  = sec.title;

  // Collect answers via ID-based radio names: `${sectionId}-${item.id}`
  const sectionAnswers = [];
  for (const it of sec.items) {
    const radios = document.getElementsByName(`${sectionId}-${it.id}`);
    let selected = "";
    for (const r of radios) { if (r.checked) { selected = r.value; break; } }
    sectionAnswers.push(selected || "Not Answered");
  }

  // Section score (ignores N/A) using the ID-based tally
  const { yes, answeredYN, score } = tallySectionById(sectionId);
  grandYes += yes;
  grandAnswered += answeredYN;

  const comments = document.querySelector(`#${sectionId}-score`).previousElementSibling.value || "";

  // Flatten rows with both stable IDs and human-readable labels
  for (let i = 0; i < sec.items.length; i++) {
    const it = sec.items[i];
    flatData.push({
      // Stable identifiers
      sectionId: sec.id,
      itemId: it.id,

      // Human-readable
      assessor, date, account, employee, appId, receivedDate, appType,
      category,
      question: it.label,
      answer: sectionAnswers[i],

      // Scores (section score matches UI)
      sectionScore: parseFloat(score.toFixed(1)),
      totalScore: 0,

      comments
    });
  }
}

  // Global total matches the UI rule: 100 * YES / (YES+NO)
  const finalTotal = grandAnswered ? parseFloat((100 * grandYes / grandAnswered).toFixed(1)) : 0;
  for (const row of flatData) row.totalScore = finalTotal;

  // Save to file (File System Access API if available; otherwise download)
  const fileName = `QA_Assessment_${appId || "Unnamed"}.json`;
  const jsonBlob = new Blob([JSON.stringify(flatData, null, 2)], { type: 'application/json' });

  if ('showSaveFilePicker' in window) {
    try {
      const handle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(jsonBlob);
      await writable.close();
      alert('File saved successfully.');
    } catch (e) {
      if (e.name !== 'AbortError') alert('Error saving file: ' + e.message);
    }
  } else {
    const url = URL.createObjectURL(jsonBlob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName; a.click();
    URL.revokeObjectURL(url);
    alert('Downloaded as fallback (browser does not support file picker).');
  }
}
function loadAssessmentData(raw) {
  const data = Array.isArray(raw?.data) ? raw.data : raw; // supports envelope or flat
  if (!Array.isArray(data)) { alert("Invalid file structure."); return; }

  const firstRow = data[0] || {};

  // Load metadata
  document.getElementById('qa-assessor').value = firstRow.assessor || "";
  document.getElementById('qa-date').value = firstRow.date || "";
  document.getElementById('account').value = firstRow.account || "";
  document.getElementById('employee-name').value = firstRow.employee || "";
  document.getElementById('app-id').value = firstRow.appId || "";
  document.getElementById('app-date').value = firstRow.receivedDate || "";
  document.getElementById('app-type').value = firstRow.appType || "";

  // 1) Try ID-based restore
  let restoredByIds = false;
  for (const row of data) {
    if (row.sectionId && row.itemId) {
      const name = `${row.sectionId}-${row.itemId}`;
      const radios = document.getElementsByName(name);
      for (const r of radios) r.checked = (r.value === row.answer);
      restoredByIds = true;
    }
  }

  // 2) Fallback to legacy (category + index) if IDs weren’t present
  if (!restoredByIds) {
  for (const row of data) {
    const sec = FORM_CONFIG.find(s => s.title === row.category);
    if (!sec) continue;                               // section renamed? IDs path would handle it
    const item = sec.items.find(it => it.label === row.question);
    if (!item) continue;                              // question label changed; nothing to set
    const name = `${sec.id}-${item.id}`;
    const radios = document.getElementsByName(name);
    for (const r of radios) r.checked = (r.value === row.answer);
  }
}

  // Restore comments by section (works for both paths)
  for (const sec of FORM_CONFIG) {
    const rows = data.filter(r => (r.sectionId === sec.id) || (r.category === sec.title));
    const commentText = rows[0]?.comments || "";
    const commentBox = document.querySelector(`#${sec.id}-score`)?.previousElementSibling;
    if (commentBox) commentBox.value = commentText;

    const icon = document.getElementById(`${sec.id}-icon`);
    if (icon) icon.classList.toggle("filled", !!commentText);

    const inlinePreview = document.getElementById(`${sec.id}-comment-inline`);
    if (inlinePreview) inlinePreview.innerHTML = commentText ? `Comment: ${commentText}` : "";
  }

  calculateScores();
  alert("Assessment loaded successfully!");
}


    buildAssessmentForm("dynamic-sections");
    document.getElementById("load-input").addEventListener("change", function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      loadAssessmentData(data);
    } catch (error) {
      alert("Invalid file format. Please select a valid assessment JSON.");
    }
  };
  reader.readAsText(file);
});

  </script>
  <div id="comment-modal" class="custom-modal" style="display: none;">
  <div class="custom-modal-content" style="max-width: 500px;">
    <h3>Edit Section Comment</h3>
    <textarea id="comment-input" rows="4" style="width: 100%; padding: 8px;"></textarea>
    <div style="margin-top: 10px; display: flex; gap: 8px;">
      <button onclick="saveComment()">Save</button>
      <button onclick="closeCommentBox()">Cancel</button>
      <button onclick="clearModalComment()" style="margin-left: auto; color: #c00;">Clear</button>
    </div>
  </div>
</div>
</body>
</html>
